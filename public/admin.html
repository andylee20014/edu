<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å‰ç¼€ç®¡ç†ç³»ç»Ÿ</title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Microsoft YaHei', sans-serif;
      line-height: 1.6;
      color: #333;
      background-color: #f5f5f5;
      padding: 20px;
    }

    .container {
      max-width: 1000px;
      margin: 0 auto;
    }

    h1, h2 {
      margin-bottom: 20px;
      color: #2c3e50;
    }

    .admin-panel {
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      margin-bottom: 30px;
    }

    .form-group {
      margin-bottom: 15px;
    }

    label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
    }

    input[type="text"],
    input[type="password"] {
      width: 100%;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 16px;
      margin-bottom: 10px;
    }

    button {
      padding: 10px 20px;
      background-color: #3498db;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
      margin-right: 10px;
    }

    button:hover {
      background-color: #2980b9;
    }

    .error-message {
      color: #e74c3c;
      margin-bottom: 15px;
      display: none;
      padding: 10px;
      background-color: #fdecea;
      border-left: 4px solid #e74c3c;
      border-radius: 3px;
      line-height: 1.5;
    }

    .success-message {
      color: #2ecc71;
      margin-bottom: 15px;
      display: none;
      padding: 10px;
      background-color: #eafaf1;
      border-left: 4px solid #2ecc71;
      border-radius: 3px;
      line-height: 1.5;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }

    th, td {
      padding: 8px;
      text-align: left;
      border-bottom: 1px solid #ddd;
      font-size: 14px;
    }

    th {
      background-color: #f2f2f2;
      font-weight: bold;
    }

    tr:hover {
      background-color: #f9f9f9;
    }

    .action-buttons button {
      padding: 3px 6px;
      margin-right: 3px;
      font-size: 12px;
    }

    .delete-btn {
      background-color: #e74c3c;
    }

    .delete-btn:hover {
      background-color: #c0392b;
    }

    .toggle-btn {
      background-color: #f39c12;
    }

    .toggle-btn:hover {
      background-color: #d35400;
    }

    .loader {
      text-align: center;
      margin: 20px 0;
      display: none;
    }

    .domain-display {
      margin-top: 5px;
      font-size: 14px;
      color: #777;
    }

    .copy-btn {
      background: none;
      border: none;
      color: #3498db;
      cursor: pointer;
      margin: 0;
      padding: 0 5px;
      font-size: 16px;
    }
    
    .copy-btn:hover {
      color: #2980b9;
      background: none;
    }
    
    .copy-toast {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background-color: rgba(0, 0, 0, 0.7);
      color: white;
      padding: 10px 20px;
      border-radius: 4px;
      font-size: 14px;
      opacity: 0;
      transition: opacity 0.3s;
      pointer-events: none;
      z-index: 1000;
    }
    
    .copy-toast.show {
      opacity: 1;
    }

    .tools-container {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
      margin-top: 15px;
    }
    
    .tool-link {
      text-decoration: none;
      color: inherit;
      flex: 1;
      min-width: 200px;
    }
    
    .tool-card {
      background: #f9f9f9;
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 15px;
      transition: all 0.3s ease;
    }
    
    .tool-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
      background: #f0f8ff;
    }
    
    .tool-icon {
      font-size: 24px;
      margin-bottom: 10px;
    }
    
    .tool-title {
      font-weight: bold;
      margin-bottom: 5px;
      color: #2c3e50;
    }
    
    .tool-desc {
      font-size: 14px;
      color: #777;
    }

    .domain-options {
      margin-bottom: 10px;
    }

    .pagination-info {
      margin-top: 10px;
      font-size: 14px;
      color: #666;
    }
    
    /* ç®¡ç†å‘˜ç™»å½•æ ·å¼ */
    .admin-login {
      max-width: 500px;
      margin: 100px auto;
      background: white;
      padding: 30px;
      border-radius: 8px;
      box-shadow: 0 2px 15px rgba(0,0,0,0.1);
      text-align: center;
    }
    
    .admin-login h2 {
      margin-bottom: 20px;
      color: #2c3e50;
    }
    
    .admin-login input {
      width: 100%;
      padding: 15px;
      margin-bottom: 20px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 16px;
    }
    
    .admin-login button {
      width: 100%;
      padding: 15px;
      background-color: #3498db;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
    }
    
    .admin-login .error-message {
      margin-top: 15px;
    }
    
    .admin-content {
      display: none; /* é»˜è®¤éšè—ç®¡ç†å†…å®¹ */
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- ç®¡ç†å‘˜ç™»å½•éƒ¨åˆ† -->
    <div id="admin-login" class="admin-login">
      <h2>å‰ç¼€ç®¡ç†ç³»ç»Ÿ - ç®¡ç†å‘˜ç™»å½•</h2>
      <input type="password" id="admin-key-input" placeholder="è¯·è¾“å…¥ç®¡ç†å‘˜å¯†é’¥">
      <button id="login-btn">ç™»å½•</button>
      <div id="login-error" class="error-message"></div>
    </div>
    
    <!-- ç®¡ç†å†…å®¹éƒ¨åˆ† - é»˜è®¤éšè— -->
    <div id="admin-content" class="admin-content">
      <h1>å‰ç¼€ç®¡ç†ç³»ç»Ÿ</h1>
      <div class="tools-container">
        <a href="/" class="tool-link" target="_blank">
          <button style="width: 100%;">å‰å¾€å‰ç¼€ç™»å½•é¡µé¢</button>
        </a>
        <a href="#" id="mailboxes-link" class="tool-link" target="_blank">
          <button style="width: 100%;">æŸ¥çœ‹å…¨éƒ¨é‚®ä»¶</button>
        </a>
      </div>
      
      <div id="management-section">
        <div class="admin-panel">
          <h2>æ·»åŠ /ä¿®æ”¹é‚®ç®±</h2>
          <div class="form-group">
            <label for="prefix">é‚®ç®±å‰ç¼€</label>
            <input type="text" id="prefix" placeholder="è¯·è¾“å…¥é‚®ç®±å‰ç¼€">
            <div class="domain-options">
              <select id="domain-select">
                <option value="loading">æ­£åœ¨åŠ è½½å¯ç”¨åŸŸå...</option>
              </select>
            </div>
          </div>
          <div class="form-group">
            <label for="password">è®¿é—®å¯†ç </label>
            <input type="text" id="password" placeholder="è¯·è¾“å…¥è®¿é—®å¯†ç ">
          </div>
          <button id="add-prefix-btn">æ·»åŠ /æ›´æ–°</button>
          <div id="add-error" class="error-message"></div>
          <div id="add-success" class="success-message"></div>

          <!-- æ‰¹é‡å¯¼å…¥åŠŸèƒ½ -->
          <div class="form-group" style="margin-top: 20px; border-top: 1px solid #eee; padding-top: 20px;">
            <h3>æ‰¹é‡å¯¼å…¥é‚®ç®±</h3>
            <p style="margin-bottom: 10px; font-size: 14px; color: #666;">
              æ¯è¡Œä¸€ä¸ªè®°å½•ï¼Œæ”¯æŒä»¥ä¸‹æ ¼å¼ï¼š
            </p>
            <div style="margin-bottom: 10px; font-size: 14px; background: #f9f9f9; padding: 10px; border-radius: 4px;">
              <div><b>æ ¼å¼1ï¼š</b> å‰ç¼€,å¯†ç  (ç”¨è‹±æ–‡é€—å·åˆ†éš”)</div>
              <div style="color: #777; margin-left: 10px;">ä¾‹å¦‚ï¼šuser1,123456</div>
              <div><b>æ ¼å¼2ï¼š</b> å‰ç¼€ å¯†ç  (ç”¨ç©ºæ ¼åˆ†éš”)</div>
              <div style="color: #777; margin-left: 10px;">ä¾‹å¦‚ï¼šuser1 123456</div>
              <div><b>æ ¼å¼3ï¼š</b> å‰ç¼€\tå¯†ç  (ç”¨åˆ¶è¡¨ç¬¦åˆ†éš”ï¼Œé€‚åˆä»Excelå¤åˆ¶)</div>
              <div style="color: #777; margin-left: 10px;">ä¾‹å¦‚ï¼šuser1[Tab]123456</div>
            </div>
            <textarea id="batch-import" rows="8" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; font-family: monospace;"></textarea>
            <div style="margin-top: 10px; display: flex; align-items: center;">
              <button id="batch-import-btn">æ‰¹é‡å¯¼å…¥</button>
              <button id="auto-generate-accounts-btn" style="margin-left: 10px; background-color: #9b59b6;">è‡ªåŠ¨ç”Ÿæˆé‚®ç®±</button>
              <button id="clear-batch-btn" style="margin-left: 10px; background-color: #7f8c8d;">æ¸…ç©º</button>
              <span id="import-status" style="margin-left: 10px; font-size: 14px;"></span>
            </div>
            <div style="margin-top: 10px; font-size: 14px; color: #666;">
              <label style="display: inline-flex; align-items: center;">
                <input type="checkbox" id="use-prefix-as-password" style="margin-right: 5px;">
                ä½¿ç”¨å‰ç¼€ä½œä¸ºé»˜è®¤å¯†ç ï¼ˆå½“æœªæŒ‡å®šå¯†ç æ—¶ï¼‰
              </label>
            </div>
            <div id="batch-error" class="error-message"></div>
            <div id="batch-success" class="success-message"></div>
          </div>

          <!-- è‡ªåŠ¨ç”Ÿæˆé‚®ç®±çš„é…ç½®é¢æ¿ -->
          <div id="auto-generate-dialog" style="display: none; margin-top: 15px; padding: 15px; background: #f5f5f5; border-radius: 4px; border: 1px solid #ddd;">
            <h4 style="margin-top: 0; margin-bottom: 10px;">è‡ªåŠ¨ç”Ÿæˆé‚®ç®±é…ç½®</h4>
            
            <div style="margin-bottom: 10px;">
              <label style="display: block; margin-bottom: 5px;">é‚®ç®±æ•°é‡</label>
              <input type="number" id="account-count" min="1" max="100" value="10" style="width: 100px; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
            </div>
            
            <div style="margin-bottom: 10px;">
              <label style="display: block; margin-bottom: 5px;">å‰ç¼€æ ¼å¼</label>
              <div style="display: flex; align-items: center;">
                <input type="text" id="prefix-format" value="user" placeholder="å‰ç¼€åŸºç¡€å" style="width: 120px; padding: 8px; border: 1px solid #ddd; border-radius: 4px; margin-right: 10px;">
                <span>+æ•°å­— (ä»</span>
                <input type="number" id="start-number" min="1" value="1" style="width: 60px; padding: 8px; border: 1px solid #ddd; border-radius: 4px; margin: 0 5px;">
                <span>å¼€å§‹)</span>
              </div>
            </div>
            
            <div style="margin-bottom: 15px;">
              <label style="display: block; margin-bottom: 5px;">é€‰æ‹©åŸŸå</label>
              <select id="auto-domain-select" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                <!-- å°†åœ¨JSä¸­åŠ¨æ€å¡«å……åŸŸååˆ—è¡¨ -->
              </select>
            </div>
            
            <div style="margin-bottom: 10px;">
              <label style="display: block; margin-bottom: 5px;">å¯†ç é€‰é¡¹</label>
              <div style="display: flex; align-items: center; margin-bottom: 5px;">
                <input type="radio" id="prefix-as-password" name="password-option" value="prefix" checked style="margin-right: 5px;">
                <label for="prefix-as-password">ä½¿ç”¨å‰ç¼€ä½œä¸ºå¯†ç </label>
              </div>
              <div style="display: flex; align-items: center; margin-bottom: 5px;">
                <input type="radio" id="random-password" name="password-option" value="random" style="margin-right: 5px;">
                <label for="random-password">ä½¿ç”¨éšæœºå¯†ç </label>
              </div>
              <div style="display: flex; align-items: center;">
                <input type="radio" id="fixed-password" name="password-option" value="fixed" style="margin-right: 5px;">
                <label for="fixed-password" style="margin-right: 10px;">å›ºå®šå¯†ç :</label>
                <input type="text" id="fixed-password-value" placeholder="è¾“å…¥å›ºå®šå¯†ç " style="padding: 8px; border: 1px solid #ddd; border-radius: 4px;" disabled>
              </div>
            </div>
            
            <div style="display: flex; justify-content: flex-end; margin-top: 15px;">
              <button id="cancel-generate" style="margin-right: 10px; background-color: #7f8c8d;">å–æ¶ˆ</button>
              <button id="confirm-generate" style="background-color: #27ae60;">ç”Ÿæˆ</button>
            </div>
          </div>
        </div>
        
        <div class="admin-panel">
          <h2>é‚®ç®±åˆ—è¡¨</h2>
          <div style="display: flex; align-items: center; margin-bottom: 10px; flex-wrap: wrap;">
            <button id="refresh-btn">åˆ·æ–°åˆ—è¡¨</button>
            
            <!-- åœ¨é¡¶éƒ¨ä¹Ÿæ·»åŠ ç¿»é¡µæ§ä»¶ -->
            <div class="pagination-controls" style="margin-left: 20px; display: flex; align-items: center;">
              <button id="top-prev-page" style="margin-right: 5px;" disabled>ä¸Šä¸€é¡µ</button>
              <span id="top-current-page">1</span> / <span id="top-total-pages">1</span>
              <button id="top-next-page" style="margin-left: 5px;" disabled>ä¸‹ä¸€é¡µ</button>
              
              <span style="margin-left: 15px;">æ¯é¡µæ˜¾ç¤º:</span>
              <select id="top-page-size" style="margin-left: 5px;">
                <option value="50">50</option>
                <option value="100" selected>100</option>
                <option value="200">200</option>
              </select>
            </div>
          </div>
          <div id="loader" class="loader">åŠ è½½ä¸­...</div>
          <div id="prefix-list">
            <div class="list-actions" style="margin-bottom: 10px; display: flex; align-items: center;">
              <label style="display: flex; align-items: center; margin-right: 15px;">
                <input type="checkbox" id="select-all-checkbox" style="margin-right: 5px;">
                <span>å…¨é€‰</span>
              </label>
              <button id="batch-delete-btn" style="background-color: #e74c3c; display: none;">æ‰¹é‡åˆ é™¤</button>
              <span id="selected-count" style="margin-left: 10px; font-size: 14px;"></span>
            </div>
            <table>
              <thead>
                <tr>
                  <th style="width: 30px;"><input type="checkbox" id="select-all-header"></th>
                  <th>é‚®ç®±å‰ç¼€</th>
                  <th>å®Œæ•´é‚®ç®±</th>
                  <th>è®¿é—®å¯†ç </th>
                  <th>åˆ›å»ºæ—¶é—´</th>
                  <th>çŠ¶æ€</th>
                  <th>æ“ä½œ</th>
                </tr>
              </thead>
              <tbody id="prefix-table-body">
              </tbody>
            </table>
            <div class="pagination" style="margin-top: 15px; display: flex; justify-content: space-between; align-items: center;">
              <div class="pagination-info">æ˜¾ç¤º <span id="start-index">0</span>-<span id="end-index">0</span> / <span id="total-count">0</span></div>
              <div class="pagination-controls">
                <button id="prev-page" style="margin-right: 5px;" disabled>ä¸Šä¸€é¡µ</button>
                <span id="current-page">1</span> / <span id="total-pages">1</span>
                <button id="next-page" style="margin-left: 5px;" disabled>ä¸‹ä¸€é¡µ</button>
              </div>
              <div class="pagination-size">
                æ¯é¡µæ˜¾ç¤º:
                <select id="page-size">
                  <option value="50">50</option>
                  <option value="100" selected>100</option>
                  <option value="200">200</option>
                </select>
              </div>
            </div>
          </div>
        </div>
        
        <div class="admin-panel">
          <h2>ç³»ç»Ÿç®¡ç†å·¥å…·</h2>
          <div class="tools-container">
            <a href="/test.html" target="_blank" class="tool-link">
              <div class="tool-card">
                <div class="tool-icon">ğŸ“¨</div>
                <div class="tool-title">é‚®ç®±æµ‹è¯•å·¥å…·</div>
                <div class="tool-desc">æ£€æŸ¥ä¸»é‚®ç®±ä¸­çš„æ‰€æœ‰é‚®ä»¶ï¼Œæ”¯æŒåˆ‡æ¢ä¸åŒçš„ä¸»é‚®ç®±ï¼Œç”¨äºè°ƒè¯•å’Œæ’æŸ¥é—®é¢˜</div>
              </div>
            </a>
            <a href="/api/mailboxes?adminKey=${adminKey}" target="_blank" class="tool-link" id="check-mailboxes">
              <div class="tool-card">
                <div class="tool-icon">ğŸ“‹</div>
                <div class="tool-title">æŸ¥çœ‹ç³»ç»Ÿé‚®ç®±é…ç½®</div>
                <div class="tool-desc">æŸ¥çœ‹å½“å‰ç³»ç»Ÿä¸­é…ç½®çš„æ‰€æœ‰ä¸»é‚®ç®±è´¦å·ä¿¡æ¯</div>
              </div>
            </a>
          </div>
        </div>
        
        <!-- å¤åˆ¶æç¤º -->
        <div id="copy-toast" class="copy-toast">å·²å¤åˆ¶åˆ°å‰ªè´´æ¿</div>
      </div>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      // åå°ç®¡ç†ç›¸å…³å…ƒç´ 
      const prefixInput = document.getElementById('prefix');
      const passwordInput = document.getElementById('password');
      const domainSelect = document.getElementById('domain-select');
      const addPrefixBtn = document.getElementById('add-prefix-btn');
      const refreshBtn = document.getElementById('refresh-btn');
      const prefixesTable = document.getElementById('prefix-table-body');
      const prefixesBody = document.getElementById('prefix-table-body');
      const addError = document.getElementById('add-error');
      const addSuccess = document.getElementById('add-success');
      const loader = document.getElementById('loader');
      
      // ç®¡ç†å‘˜ç™»å½•ç›¸å…³å…ƒç´ 
      const adminLoginSection = document.getElementById('admin-login');
      const adminContentSection = document.getElementById('admin-content');
      const adminKeyInput = document.getElementById('admin-key-input');
      const loginBtn = document.getElementById('login-btn');
      const loginError = document.getElementById('login-error');
      
      // é‚®ç®±ç®¡ç†å·¥å…·
      const mailboxesLink = document.getElementById('mailboxes-link');
      
      // æ‰¹é‡å¯¼å…¥ç›¸å…³å…ƒç´ 
      const batchImportBtn = document.getElementById('batch-import-btn');
      const batchImportDialog = document.getElementById('batch-import-dialog');
      const batchImportTextarea = document.getElementById('batch-import');
      const confirmBatchImportBtn = document.getElementById('confirm-batch-import');
      const cancelBatchImportBtn = document.getElementById('clear-batch-btn');
      const usePrefixAsPasswordCheckbox = document.getElementById('use-prefix-as-password');
      
      // å®šä¹‰å˜é‡
      let adminKey = '';
      let prefixesData = {};
      
      // ç¿»é¡µå’Œæ‰¹é‡åˆ é™¤ç›¸å…³å…ƒç´ 
      const selectAllCheckbox = document.getElementById('select-all-checkbox');
      const selectAllHeader = document.getElementById('select-all-header');
      const batchDeleteBtn = document.getElementById('batch-delete-btn');
      const selectedCount = document.getElementById('selected-count');
      const prevPageBtn = document.getElementById('prev-page');
      const nextPageBtn = document.getElementById('next-page');
      const currentPageSpan = document.getElementById('current-page');
      const totalPagesSpan = document.getElementById('total-pages');
      const startIndexSpan = document.getElementById('start-index');
      const endIndexSpan = document.getElementById('end-index');
      const totalCountSpan = document.getElementById('total-count');
      const pageSizeSelect = document.getElementById('page-size');
      
      // ç¿»é¡µç›¸å…³å˜é‡
      let currentPage = 1;
      let pageSize = 100;
      let availableDomains = [];
      
      // æ‰¹é‡å¯¼å…¥ç›¸å…³å…ƒç´ 
      const importStatus = document.getElementById('import-status');
      const batchError = document.getElementById('batch-error');
      const batchSuccess = document.getElementById('batch-success');
      
      // è‡ªåŠ¨ç”Ÿæˆé‚®ç®±ç›¸å…³å…ƒç´ 
      const autoGenerateAccountsBtn = document.getElementById('auto-generate-accounts-btn');
      const autoGenerateDialog = document.getElementById('auto-generate-dialog');
      const accountCountInput = document.getElementById('account-count');
      const prefixFormatInput = document.getElementById('prefix-format');
      const startNumberInput = document.getElementById('start-number');
      const autoDomainSelect = document.getElementById('auto-domain-select');
      const prefixAsPasswordRadio = document.getElementById('prefix-as-password');
      const randomPasswordRadio = document.getElementById('random-password');
      const fixedPasswordRadio = document.getElementById('fixed-password');
      const fixedPasswordInput = document.getElementById('fixed-password-value');
      const cancelGenerateBtn = document.getElementById('cancel-generate');
      const confirmGenerateBtn = document.getElementById('confirm-generate');
      
      // è®¾ç½®æ‰¹é‡å¯¼å…¥æ–‡æœ¬æ¡†çš„é»˜è®¤æ ·å¼
      batchImportTextarea.style.fontFamily = 'Consolas, Monaco, "Courier New", monospace';
      batchImportTextarea.style.fontSize = '14px';
      batchImportTextarea.style.lineHeight = '1.6';
      batchImportTextarea.style.padding = '12px';
      batchImportTextarea.style.backgroundColor = '#f8f9fa';
      batchImportTextarea.style.border = '1px solid #ddd';
      batchImportTextarea.style.borderRadius = '4px';
      batchImportTextarea.style.boxShadow = 'inset 0 1px 3px rgba(0,0,0,0.05)';
      
      // æ£€æŸ¥å…ƒç´ æ˜¯å¦æ­£ç¡®è·å–
      console.log('å…ƒç´ è·å–æƒ…å†µï¼š', {
        autoGenerateAccountsBtn: !!autoGenerateAccountsBtn,
        autoGenerateDialog: !!autoGenerateDialog,
        confirmGenerateBtn: !!confirmGenerateBtn,
        cancelGenerateBtn: !!cancelGenerateBtn
      });
      
      // å¦‚æœè·å–åˆ°äº†æŒ‰é’®ï¼Œæ·»åŠ è°ƒè¯•ç‚¹å‡»äº‹ä»¶
      if (autoGenerateAccountsBtn) {
        console.log('å·²è·å–è‡ªåŠ¨ç”Ÿæˆé‚®ç®±æŒ‰é’®');
      }
      
      // åˆå§‹åŒ–é¡µé¢
      async function initializePage() {
        try {
          // æ›´æ–°é“¾æ¥
          updateMailboxesLink();
          
          // åŠ è½½åŸŸååˆ—è¡¨
          await loadDomains();
          
          // åˆå§‹åŒ–ç¿»é¡µå’Œæ‰¹é‡æ“ä½œåŠŸèƒ½
          initPaginationAndBatchActions();
          
          // åŠ è½½å‰ç¼€åˆ—è¡¨
          loadPrefixes();
        } catch (error) {
          console.error('åˆå§‹åŒ–é¡µé¢æ—¶å‡ºé”™:', error);
          showError(addError, 'åˆå§‹åŒ–é¡µé¢æ—¶å‡ºé”™: ' + error.message);
        }
      }
      
      // ç™»å½•å¤„ç†å‡½æ•°
      loginBtn.addEventListener('click', async () => {
        const key = adminKeyInput.value.trim();
        if (!key) {
          showLoginError('è¯·è¾“å…¥ç®¡ç†å‘˜å¯†é’¥');
          return;
        }
        
        try {
          const response = await fetch(`/api/admin/prefixes?adminKey=${key}`);
          
          if (response.ok) {
            // ç™»å½•æˆåŠŸ
            adminKey = key;
            adminLoginSection.style.display = 'none';
            adminContentSection.style.display = 'block';
            
            // åˆå§‹åŒ–ç®¡ç†ç•Œé¢
            initializePage();
          } else {
            showLoginError('ç®¡ç†å‘˜å¯†é’¥æ— æ•ˆ');
          }
        } catch (error) {
          showLoginError('è¿æ¥æœåŠ¡å™¨æ—¶å‡ºé”™');
          console.error('éªŒè¯ç®¡ç†å‘˜å¯†é’¥æ—¶å‡ºé”™:', error);
        }
      });
      
      // æ˜¾ç¤ºç™»å½•é”™è¯¯ä¿¡æ¯
      function showLoginError(message) {
        loginError.textContent = message;
        loginError.style.display = 'block';
        setTimeout(() => {
          loginError.style.display = 'none';
        }, 5000);
      }
      
      // è·å–ç®¡ç†å‘˜å¯†é’¥ - ä¸å†ä½¿ç”¨æ­¤å‡½æ•°ï¼Œç•™ç»™æµ‹è¯•ç¯å¢ƒ
      async function getAdminKey() {
        return adminKey;
      }
      
      // åŠ è½½å¯ç”¨çš„åŸŸååˆ—è¡¨
      async function loadDomains() {
        try {
          const response = await fetch(`/api/mailboxes?adminKey=${adminKey}`);
          
          if (!response.ok) {
            throw new Error('è·å–é‚®ç®±åˆ—è¡¨å¤±è´¥');
          }
          
          const data = await response.json();
          availableDomains = data.mailboxes && data.mailboxes.length > 0
            ? data.mailboxes.map(mailbox => mailbox.domain)
            : ['wandouyu.digitalscholarship.brown.edu'];
          
          // æ›´æ–°åŸŸåä¸‹æ‹‰èœå•
          domainSelect.innerHTML = '';
          availableDomains.forEach(domain => {
            const option = document.createElement('option');
            option.value = domain;
            option.textContent = `@${domain}`;
            domainSelect.appendChild(option);
          });
        } catch (error) {
          console.error('åŠ è½½åŸŸååˆ—è¡¨æ—¶å‡ºé”™:', error);
          showError(addError, 'åŠ è½½åŸŸååˆ—è¡¨æ—¶å‡ºé”™ï¼Œä½¿ç”¨é»˜è®¤åŸŸå');
          
          // ä½¿ç”¨é»˜è®¤åŸŸå
          domainSelect.innerHTML = '';
          const option = document.createElement('option');
          option.value = 'wandouyu.digitalscholarship.brown.edu';
          option.textContent = '@wandouyu.digitalscholarship.brown.edu';
          domainSelect.appendChild(option);
        }
      }
      
      addPrefixBtn.addEventListener('click', async () => {
        const prefix = prefixInput.value.trim();
        const password = passwordInput.value.trim();
        
        if (!prefix) {
          showError(addError, 'è¯·è¾“å…¥å‰ç¼€');
          return;
        }
        
        if (!password) {
          showError(addError, 'è¯·è¾“å…¥å¯†ç ');
          return;
        }
        
        try {
          const response = await fetch('/api/admin/prefixes', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              adminKey,
              prefix,
              password
            })
          });
          
          const data = await response.json();
          
          if (response.ok) {
            // æ˜¾ç¤ºå®Œæ•´é‚®ç®±åœ°å€
            const domain = domainSelect.value;
            const fullEmail = `${prefix}@${domain}`;
            showSuccess(addSuccess, `${data.message || 'å‰ç¼€æ·»åŠ /æ›´æ–°æˆåŠŸ'} (${fullEmail})`);
            
            prefixInput.value = '';
            passwordInput.value = '';
            
            // é‡æ–°åŠ è½½å‰ç¼€åˆ—è¡¨
            loadPrefixes();
          } else {
            showError(addError, data.error || 'æ·»åŠ /æ›´æ–°å‰ç¼€æ—¶å‡ºé”™');
          }
        } catch (error) {
          showError(addError, 'è¿æ¥æœåŠ¡å™¨æ—¶å‡ºé”™');
          console.error('æ·»åŠ /æ›´æ–°å‰ç¼€æ—¶å‡ºé”™:', error);
        }
      });
      
      refreshBtn.addEventListener('click', () => {
        currentPage = 1; // é‡ç½®åˆ°ç¬¬ä¸€é¡µ
        loadPrefixes();
      });
      
      async function loadPrefixes() {
        loader.style.display = 'block';
        
        try {
          const response = await fetch(`/api/admin/prefixes?adminKey=${adminKey}`);
          
          if (response.ok) {
            const data = await response.json();
            prefixesData = data.prefixes || {};
            totalItems = Object.keys(prefixesData).length;
            
            // æ›´æ–°åˆ†é¡µä¿¡æ¯
            updatePaginationInfo();
            
            // æ˜¾ç¤ºå½“å‰é¡µçš„å‰ç¼€
            displayCurrentPagePrefixes();
          } else {
            showError(addError, 'åŠ è½½å‰ç¼€åˆ—è¡¨æ—¶å‡ºé”™');
          }
        } catch (error) {
          showError(addError, 'è¿æ¥æœåŠ¡å™¨æ—¶å‡ºé”™');
          console.error('åŠ è½½å‰ç¼€åˆ—è¡¨æ—¶å‡ºé”™:', error);
        } finally {
          loader.style.display = 'none';
        }
      }
      
      // æ›´æ–°åˆ†é¡µä¿¡æ¯
      function updatePaginationInfo() {
        const totalPages = Math.ceil(totalItems / pageSize) || 1;
        
        // ç¡®ä¿å½“å‰é¡µä¸è¶…å‡ºèŒƒå›´
        if (currentPage > totalPages) {
          currentPage = totalPages;
        } else if (currentPage < 1) {
          currentPage = 1;
        }
        
        console.log('æ›´æ–°åˆ†é¡µä¿¡æ¯', { currentPage, totalPages, totalItems });
        
        const startIndex = (currentPage - 1) * pageSize + 1;
        const endIndex = Math.min(startIndex + pageSize - 1, totalItems);
        
        // æ›´æ–°åº•éƒ¨é¡µé¢æ˜¾ç¤º
        currentPageSpan.textContent = currentPage;
        totalPagesSpan.textContent = totalPages;
        startIndexSpan.textContent = totalItems > 0 ? startIndex : 0;
        endIndexSpan.textContent = endIndex;
        totalCountSpan.textContent = totalItems;
        
        // æ›´æ–°é¡¶éƒ¨é¡µé¢æ˜¾ç¤º
        const topCurrentPageSpan = document.getElementById('top-current-page');
        const topTotalPagesSpan = document.getElementById('top-total-pages');
        if (topCurrentPageSpan) topCurrentPageSpan.textContent = currentPage;
        if (topTotalPagesSpan) topTotalPagesSpan.textContent = totalPages;
        
        // æ›´æ–°æŒ‰é’®çŠ¶æ€ - åº•éƒ¨
        prevPageBtn.disabled = currentPage <= 1;
        nextPageBtn.disabled = currentPage >= totalPages;
        
        // æ›´æ–°æŒ‰é’®çŠ¶æ€ - é¡¶éƒ¨
        const topPrevPageBtn = document.getElementById('top-prev-page');
        const topNextPageBtn = document.getElementById('top-next-page');
        if (topPrevPageBtn) topPrevPageBtn.disabled = currentPage <= 1;
        if (topNextPageBtn) topNextPageBtn.disabled = currentPage >= totalPages;
      }
      
      // æ˜¾ç¤ºå½“å‰é¡µçš„å‰ç¼€
      function displayCurrentPagePrefixes() {
        prefixesTable.innerHTML = '';
        
        if (!prefixesData || Object.keys(prefixesData).length === 0) {
          const row = document.createElement('tr');
          row.innerHTML = '<td colspan="7">æ²¡æœ‰æ‰¾åˆ°é‚®ç®±</td>';
          prefixesTable.appendChild(row);
          
          // éšè—æ‰¹é‡åˆ é™¤æŒ‰é’®
          batchDeleteBtn.style.display = 'none';
          selectAllCheckbox.checked = false;
          selectAllHeader.checked = false;
          return;
        }
        
        // æŒ‰åˆ›å»ºæ—¶é—´æ’åºï¼Œæœ€æ–°çš„æ’åœ¨å‰é¢
        const sortedPrefixes = Object.entries(prefixesData).sort((a, b) => {
          return new Date(b[1].createdAt) - new Date(a[1].createdAt);
        });
        
        // è·å–å½“å‰é¡µçš„å‰ç¼€
        const startIndex = (currentPage - 1) * pageSize;
        const endIndex = startIndex + pageSize;
        const currentPagePrefixes = sortedPrefixes.slice(startIndex, endIndex);
        
        // è·å–å…è®¸çš„åŸŸååˆ—è¡¨
        fetch(`/api/mailboxes?adminKey=${adminKey}`)
          .then(response => response.json())
          .then(data => {
            // è·å–å½“å‰é€‰æ‹©çš„åŸŸåæˆ–ä½¿ç”¨ç¬¬ä¸€ä¸ªåŸŸå
            let currentDomain = domainSelect.value;
            let availableDomains = [];
            
            if (data.mailboxes && data.mailboxes.length > 0) {
              availableDomains = data.mailboxes.map(mailbox => mailbox.domain);
              if (!currentDomain && availableDomains.length > 0) {
                currentDomain = availableDomains[0];
              }
            }
            
            // ç¡®ä¿è‡³å°‘æœ‰ä¸€ä¸ªåŸŸåå¯ç”¨
            if (!currentDomain) {
              currentDomain = 'wandouyu.digitalscholarship.brown.edu';
            }
            
            // æ¸²æŸ“å‰ç¼€åˆ—è¡¨ï¼Œåªä½¿ç”¨ä¸€ä¸ªåŸŸå
            for (const [prefix, data] of currentPagePrefixes) {
              renderPrefixRow(prefix, data, currentDomain);
            }
            
            // æ·»åŠ äº‹ä»¶å¤„ç†ç¨‹åº
            addEventHandlers();
          })
          .catch(error => {
            console.error('è·å–åŸŸååˆ—è¡¨æ—¶å‡ºé”™:', error);
            // ä½¿ç”¨é»˜è®¤åŸŸå
            const defaultDomain = 'wandouyu.digitalscholarship.brown.edu';
            
            // æ¸²æŸ“å½“å‰é¡µçš„å‰ç¼€
            for (const [prefix, data] of currentPagePrefixes) {
              renderPrefixRow(prefix, data, defaultDomain);
            }
            
            // æ·»åŠ äº‹ä»¶å¤„ç†ç¨‹åº
            addEventHandlers();
          });
        
        // é‡ç½®é€‰æ‹©çŠ¶æ€
        updateSelectionStatus();
      }
      
      // è¾…åŠ©å‡½æ•°ï¼Œæ¸²æŸ“å•ä¸ªå‰ç¼€è¡Œ
      function renderPrefixRow(prefix, data, domain) {
        const row = document.createElement('tr');
        row.dataset.prefix = prefix;
        
        const fullEmail = `${prefix}@${domain}`;
        const createdAt = new Date(data.createdAt).toLocaleString('zh-CN');
        const status = data.active ? 'å¯ç”¨' : 'ç¦ç”¨';
        
        // é‚®ç®±æ˜¾ç¤º - åªæ˜¾ç¤ºä¸»åŸŸåï¼Œè€Œä¸æ˜¯æ‰€æœ‰åŸŸå
        const emailsHtml = `
          ${fullEmail}
          <button class="copy-btn" data-copy="${fullEmail}" title="å¤åˆ¶é‚®ç®±">ğŸ“‹</button>
        `;
        
        // å°†æ“ä½œæŒ‰é’®æ”¾åœ¨åŒä¸€è¡Œï¼Œä½¿ç”¨æ›´ç´§å‡‘çš„æ ·å¼
        const actionButtons = `
          <button class="toggle-btn" data-prefix="${prefix}" data-active="${!data.active}" style="padding: 3px 6px; font-size: 12px;">
            ${data.active ? 'ç¦ç”¨' : 'å¯ç”¨'}
          </button>
          <button class="delete-btn" data-prefix="${prefix}" style="padding: 3px 6px; font-size: 12px;">åˆ é™¤</button>
          <button class="copy-btn" data-copy="${fullEmail}&&${data.password}" title="å¤åˆ¶é‚®ç®±å’Œå¯†ç " style="padding: 3px 6px; font-size: 12px;">å¤åˆ¶å…¨éƒ¨</button>
        `;
        
        row.innerHTML = `
          <td><input type="checkbox" class="row-checkbox" data-prefix="${prefix}"></td>
          <td>${prefix}</td>
          <td>${emailsHtml}</td>
          <td>
            ${data.password}
            <button class="copy-btn" data-copy="${data.password}" title="å¤åˆ¶å¯†ç ">ğŸ“‹</button>
          </td>
          <td>${createdAt}</td>
          <td>${status}</td>
          <td class="action-buttons" style="white-space: nowrap;">${actionButtons}</td>
        `;
        
        prefixesTable.appendChild(row);
      }
      
      // æ·»åŠ äº‹ä»¶å¤„ç†ç¨‹åº
      function addEventHandlers() {
        // æ·»åŠ å¤åˆ¶æŒ‰é’®äº‹ä»¶
        document.querySelectorAll('.copy-btn').forEach(btn => {
          btn.addEventListener('click', () => {
            const text = btn.getAttribute('data-copy');
            
            // å¦‚æœåŒ…å«&&ï¼Œä»£è¡¨éœ€è¦æ ¼å¼åŒ–å¤åˆ¶å¤šä¸ªå†…å®¹
            let copyText = text;
            if (text.includes('&&')) {
              const [email, password] = text.split('&&');
              copyText = `é‚®ç®±: ${email}\nå¯†ç : ${password}`;
            }
            
            copyToClipboard(copyText);
            showCopyToast();
          });
        });
        
        // æ·»åŠ åˆ é™¤æŒ‰é’®äº‹ä»¶
        document.querySelectorAll('.delete-btn').forEach(btn => {
          btn.addEventListener('click', async () => {
            const prefix = btn.getAttribute('data-prefix');
            if (confirm(`ç¡®å®šè¦åˆ é™¤å‰ç¼€ "${prefix}" å—ï¼Ÿ`)) {
              await deletePrefix(prefix);
            }
          });
        });
        
        // æ·»åŠ åˆ‡æ¢çŠ¶æ€æŒ‰é’®äº‹ä»¶
        document.querySelectorAll('.toggle-btn').forEach(btn => {
          btn.addEventListener('click', async () => {
            const prefix = btn.getAttribute('data-prefix');
            const active = btn.getAttribute('data-active') === 'true';
            await togglePrefixStatus(prefix, active);
          });
        });
        
        // æ·»åŠ è¡Œé€‰æ‹©æ¡†äº‹ä»¶
        document.querySelectorAll('.row-checkbox').forEach(checkbox => {
          checkbox.addEventListener('change', () => {
            updateSelectionStatus();
          });
        });
      }
      
      async function deletePrefix(prefix) {
        try {
          const response = await fetch(`/api/admin/prefixes/${prefix}`, {
            method: 'DELETE',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({ adminKey })
          });
          
          const data = await response.json();
          
          if (response.ok) {
            showSuccess(addSuccess, data.message || `å‰ç¼€ ${prefix} å·²åˆ é™¤`);
            loadPrefixes();
          } else {
            showError(addError, data.error || 'åˆ é™¤å‰ç¼€æ—¶å‡ºé”™');
          }
        } catch (error) {
          showError(addError, 'è¿æ¥æœåŠ¡å™¨æ—¶å‡ºé”™');
          console.error('åˆ é™¤å‰ç¼€æ—¶å‡ºé”™:', error);
        }
      }
      
      async function togglePrefixStatus(prefix, active) {
        try {
          const response = await fetch(`/api/admin/prefixes/${prefix}/status`, {
            method: 'PUT',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({ 
              adminKey,
              active
            })
          });
          
          const data = await response.json();
          
          if (response.ok) {
            showSuccess(addSuccess, data.message || `å‰ç¼€ ${prefix} çŠ¶æ€å·²æ›´æ–°`);
            loadPrefixes();
          } else {
            showError(addError, data.error || 'æ›´æ–°å‰ç¼€çŠ¶æ€æ—¶å‡ºé”™');
          }
        } catch (error) {
          showError(addError, 'è¿æ¥æœåŠ¡å™¨æ—¶å‡ºé”™');
          console.error('æ›´æ–°å‰ç¼€çŠ¶æ€æ—¶å‡ºé”™:', error);
        }
      }
      
      // å¤åˆ¶åˆ°å‰ªè´´æ¿
      function copyToClipboard(text) {
        const textarea = document.createElement('textarea');
        textarea.value = text;
        textarea.style.position = 'fixed';
        textarea.style.opacity = 0;
        document.body.appendChild(textarea);
        textarea.select();
        
        try {
          document.execCommand('copy');
        } catch (err) {
          console.error('å¤åˆ¶å¤±è´¥:', err);
        }
        
        document.body.removeChild(textarea);
      }
      
      // æ˜¾ç¤ºå¤åˆ¶æç¤º
      function showCopyToast() {
        const toast = document.getElementById('copy-toast');
        toast.classList.add('show');
        
        setTimeout(() => {
          toast.classList.remove('show');
        }, 2000);
      }
      
      function showError(element, message) {
        element.innerHTML = message.replace(/\n/g, '<br>');
        element.style.display = 'block';
        setTimeout(() => {
          element.style.display = 'none';
        }, 5000);
      }
      
      function showSuccess(element, message) {
        element.innerHTML = message.replace(/\n/g, '<br>');
        element.style.display = 'block';
        setTimeout(() => {
          element.style.display = 'none';
        }, 5000);
      }
      
      // æ˜¾ç¤ºä¿¡æ¯æç¤º
      function showInfo(element, message) {
        element.textContent = message;
        element.style.display = 'block';
        element.style.color = '#3498db';
      }
      
      // æ›´æ–°åŠ¨æ€ç”Ÿæˆçš„mailboxesé“¾æ¥
      function updateMailboxesLink() {
        const checkMailboxesLink = document.getElementById('check-mailboxes');
        if (checkMailboxesLink) {
          checkMailboxesLink.href = `/api/mailboxes?adminKey=${adminKey}`;
        }
      }
      
      // è‡ªåŠ¨ç”Ÿæˆé‚®ç®±åŠŸèƒ½ç›¸å…³äº‹ä»¶å¤„ç†
      
      // æ¸…ç©ºæŒ‰é’®
      cancelBatchImportBtn.addEventListener('click', () => {
        if (batchImportTextarea.value.trim() && !confirm('ç¡®å®šè¦æ¸…ç©ºè¾“å…¥æ¡†å†…å®¹å—ï¼Ÿ')) {
          return;
        }
        
        batchImportTextarea.value = '';
        importStatus.textContent = '';
        batchError.style.display = 'none';
        batchSuccess.style.display = 'none';
      });
      
      // ç”Ÿæˆé‚®ç®±åˆ—è¡¨å‡½æ•°
      function generateEmails(count, prefixBase, startNumber, domain, passwordType, fixedPassword = '') {
        const accounts = [];
        for (let i = 0; i < count; i++) {
          const number = startNumber + i;
          const prefix = `${prefixBase}${number}`;
          const fullEmail = `${prefix}@${domain}`; // å®Œæ•´é‚®ç®±åœ°å€
          
          // æ ¹æ®å¯†ç ç±»å‹ç”Ÿæˆå¯†ç 
          let password;
          if (passwordType === 'prefix') {
            password = prefix;
          } else if (passwordType === 'fixed') {
            password = fixedPassword;
          } else if (passwordType === 'random') {
            // ç”Ÿæˆ8-12ä½éšæœºå¯†ç ï¼ŒåŒ…å«å­—æ¯å’Œæ•°å­—
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
            const length = 8 + Math.floor(Math.random() * 5); // 8-12ä½
            let randomPassword = '';
            for (let j = 0; j < length; j++) {
              randomPassword += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            password = randomPassword;
          } else {
            password = prefix; // é»˜è®¤ä½¿ç”¨å‰ç¼€ä½œä¸ºå¯†ç 
          }
          
          // è¿”å›å®Œæ•´é‚®ç®±å’Œå¯†ç 
          accounts.push(`${fullEmail},${password}`);
        }
        return accounts;
      }
      
      // ç›´æ¥ç”¨onclickå±æ€§ç»‘å®šäº‹ä»¶ï¼Œé¿å…é‡å¤ç»‘å®š
      autoGenerateAccountsBtn.onclick = function() {
        console.log('è‡ªåŠ¨ç”Ÿæˆé‚®ç®±æŒ‰é’®è¢«ç‚¹å‡»');
        // åˆå§‹åŒ–åŸŸåä¸‹æ‹‰èœå•
        updateAutoDomainSelect();
        // æ˜¾ç¤ºé…ç½®å¯¹è¯æ¡†
        autoGenerateDialog.style.display = 'block';
      };
      
      // å–æ¶ˆç”Ÿæˆ
      cancelGenerateBtn.onclick = function() {
        console.log('å–æ¶ˆç”ŸæˆæŒ‰é’®è¢«ç‚¹å‡»');
        autoGenerateDialog.style.display = 'none';
      };
      
      // å›ºå®šå¯†ç é€‰é¡¹çŠ¶æ€ç®¡ç†
      fixedPasswordRadio.onchange = function() {
        fixedPasswordInput.disabled = !fixedPasswordRadio.checked;
        if (fixedPasswordRadio.checked) {
          fixedPasswordInput.focus();
        }
      };
      
      prefixAsPasswordRadio.onchange = function() {
        fixedPasswordInput.disabled = true;
      };
      
      // ç¡®è®¤ç”Ÿæˆé‚®ç®±
      confirmGenerateBtn.onclick = function() {
        console.log('ç¡®è®¤ç”ŸæˆæŒ‰é’®è¢«ç‚¹å‡»');
        
        // è·å–é…ç½®å‚æ•°
        const count = parseInt(accountCountInput.value) || 10;
        const prefixBase = prefixFormatInput.value.trim() || 'user';
        const startNumber = parseInt(startNumberInput.value) || 1;
        const domain = autoDomainSelect.value;
        
        console.log('ç”Ÿæˆå‚æ•°:', {count, prefixBase, startNumber, domain});
        
        // æ£€æŸ¥å‚æ•°æœ‰æ•ˆæ€§
        if (count <= 0 || count > 100) {
          showError(batchError, 'é‚®ç®±æ•°é‡å¿…é¡»åœ¨1-100ä¹‹é—´');
          return;
        }
        
        if (!prefixBase) {
          showError(batchError, 'å‰ç¼€æ ¼å¼ä¸èƒ½ä¸ºç©º');
          return;
        }
        
        // ç¡®å®šå¯†ç ç±»å‹
        let passwordType = 'prefix';
        let fixedPassword = '';
        
        if (document.getElementById('random-password').checked) {
          passwordType = 'random';
        } else if (document.getElementById('prefix-as-password').checked) {
          passwordType = 'prefix';
        } else if (document.getElementById('fixed-password').checked) {
          passwordType = 'fixed';
          fixedPassword = fixedPasswordInput.value.trim();
          
          if (!fixedPassword) {
            showError(batchError, 'è¯·è¾“å…¥å›ºå®šå¯†ç ');
            return;
          }
        }
        
        console.log('å¯†ç ç±»å‹:', passwordType);
        
        try {
          // ç”Ÿæˆé‚®ç®±åˆ—è¡¨
          const accounts = generateEmails(count, prefixBase, startNumber, domain, passwordType, fixedPassword);
          console.log('ç”Ÿæˆçš„è´¦å·:', accounts);
          
          // ä½¿ç”¨åˆ¶è¡¨ç¬¦åˆ†éš”çš„æ ¼å¼å¡«å……åˆ°æ‰¹é‡å¯¼å…¥æ–‡æœ¬æ¡†ï¼Œä½¿æ˜¾ç¤ºæ›´æ•´é½
          batchImportTextarea.value = accounts.join('\n');
          
          // éšè—å¯¹è¯æ¡†å¹¶æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
          autoGenerateDialog.style.display = 'none';
          
          // ç¾åŒ–æ˜¾ç¤º
          formatBatchTextarea();
          
          // æ˜¾ç¤ºè¯¦ç»†çš„æˆåŠŸä¿¡æ¯
          let passwordTypeText = 'ä¸å‰ç¼€ç›¸åŒçš„å¯†ç ';
          if (passwordType === 'fixed') {
            passwordTypeText = `å›ºå®šå¯†ç  "${fixedPassword}"`;
          } else if (passwordType === 'random') {
            passwordTypeText = 'éšæœºå¯†ç ';
          }
          
          showSuccess(batchSuccess, `å·²ç”Ÿæˆ ${count} ä¸ªé‚®ç®±è´¦å·
- æ ¼å¼: ${prefixBase}${startNumber} ~ ${prefixBase}${startNumber + count - 1}@${domain}
- å¯†ç ç±»å‹: ${passwordTypeText}`);
          
          // æ›´æ–°å¯¼å…¥çŠ¶æ€æç¤º
          importStatus.textContent = `å·²å‡†å¤‡å¥½ ${count} ä¸ªé‚®ç®±è´¦å·ï¼Œå¯ç‚¹å‡»"æ‰¹é‡å¯¼å…¥"æŒ‰é’®å¯¼å…¥ç³»ç»Ÿ`;
          importStatus.style.color = '#27ae60';
        } catch (error) {
          console.error('ç”Ÿæˆé‚®ç®±æ—¶å‡ºé”™:', error);
          showError(batchError, 'ç”Ÿæˆé‚®ç®±æ—¶å‡ºé”™: ' + error.message);
        }
      };
      
      // æ ¼å¼åŒ–æ‰¹é‡å¯¼å…¥æ–‡æœ¬æ¡†å†…å®¹ï¼Œä½¿å…¶çœ‹èµ·æ¥æ›´ç¾è§‚
      function formatBatchTextarea() {
        const lines = batchImportTextarea.value.trim().split('\n');
        if (lines.length === 0) return;
        
        // è®¾ç½®æ–‡æœ¬æ¡†æ ·å¼ä¸ºç­‰å®½å­—ä½“ï¼Œä¾¿äºå¯¹é½
        batchImportTextarea.style.fontFamily = 'Consolas, Monaco, "Courier New", monospace';
        batchImportTextarea.style.fontSize = '14px';
        batchImportTextarea.style.lineHeight = '1.6';
        batchImportTextarea.style.padding = '12px';
        batchImportTextarea.style.backgroundColor = '#f8f9fa';
        batchImportTextarea.style.border = '1px solid #ddd';
        batchImportTextarea.style.borderRadius = '4px';
        batchImportTextarea.style.boxShadow = 'inset 0 1px 3px rgba(0,0,0,0.05)';
        
        // ä¸ºäº†ä¿æŒç¾è§‚ï¼Œæˆ‘ä»¬å¯ä»¥ç¡®ä¿æ‰€æœ‰è¡Œéƒ½ä¿æŒåŸæ ·ï¼Œä¸æ·»åŠ é¢å¤–çš„æ ¼å¼åŒ–
        // ä½†æ˜¯å¯ä»¥æŒ‰ç…§å›ºå®šæ ¼å¼å±•ç¤ºï¼Œå¦‚æœéœ€è¦çš„è¯
      }
      
      // æ›´æ–°è‡ªåŠ¨ç”Ÿæˆçš„åŸŸåä¸‹æ‹‰èœå•
      function updateAutoDomainSelect() {
        // å…ˆæ¸…ç©ºç°æœ‰é€‰é¡¹
        autoDomainSelect.innerHTML = '';
        
        // ä½¿ç”¨å·²åŠ è½½çš„å¯ç”¨åŸŸååˆ—è¡¨
        if (availableDomains && availableDomains.length > 0) {
          availableDomains.forEach(domain => {
            const option = document.createElement('option');
            option.value = domain;
            option.textContent = `@${domain}`;
            autoDomainSelect.appendChild(option);
          });
        } else {
          // å¦‚æœå°šæœªåŠ è½½åŸŸåæˆ–æ— å¯ç”¨åŸŸåï¼Œä½¿ç”¨é»˜è®¤åŸŸå
          const option = document.createElement('option');
          option.value = 'wandouyu.digitalscholarship.brown.edu';
          option.textContent = '@wandouyu.digitalscholarship.brown.edu';
          autoDomainSelect.appendChild(option);
        }
      }

      // æ‰¹é‡å¯¼å…¥åŠŸèƒ½
      batchImportBtn.addEventListener('click', async () => {
        const batchData = batchImportTextarea.value.trim();
        
        if (!batchData) {
          showError(batchError, 'è¯·è¾“å…¥è¦å¯¼å…¥çš„æ•°æ®');
          return;
        }
        
        // è§£æè¾“å…¥æ•°æ®ï¼Œæ¯è¡Œä¸€æ¡è®°å½•ï¼Œæ”¯æŒå¤šç§æ ¼å¼
        const lines = batchData.split(/\r?\n/).filter(line => line.trim());
        
        if (lines.length === 0) {
          showError(batchError, 'æ²¡æœ‰æ‰¾åˆ°æœ‰æ•ˆçš„å¯¼å…¥è®°å½•');
          return;
        }
        
        // æ˜¾ç¤ºæ‰¹é‡å¯¼å…¥æç¤º
        importStatus.textContent = 'æ­£åœ¨å¤„ç†æ‰¹é‡å¯¼å…¥è¯·æ±‚...';
        importStatus.style.color = '#3498db';
        
        const records = [];
        const invalidLines = [];
        const usePrefixAsPassword = usePrefixAsPasswordCheckbox ? usePrefixAsPasswordCheckbox.checked : false;
        
        // è§£ææ¯ä¸€è¡Œ
        lines.forEach((line, index) => {
          // æ”¯æŒå¤šç§åˆ†éš”ç¬¦ï¼šé€—å·ã€ç©ºæ ¼ã€åˆ¶è¡¨ç¬¦
          let parts = [];
          
          if (line.includes(',')) {
            // é€—å·åˆ†éš”
            parts = line.split(',').map(part => part.trim());
          } else if (line.includes('\t')) {
            // Tabåˆ†éš”
            parts = line.split('\t').map(part => part.trim());
          } else {
            // ç©ºæ ¼åˆ†éš”
            parts = line.split(/\s+/).filter(Boolean);
          }
          
          // æå–é‚®ç®±ï¼ˆå¯èƒ½åŒ…å«å®Œæ•´é‚®ç®±åœ°å€ï¼‰å’Œå¯†ç 
          let emailOrPrefix = parts[0];
          let password = parts[1];
          
          // è§£æé‚®ç®±åœ°å€
          let prefix, domain;
          if (emailOrPrefix && emailOrPrefix.includes('@')) {
            // æå–é‚®ç®±ä¸­çš„å‰ç¼€å’ŒåŸŸåéƒ¨åˆ†
            const emailParts = emailOrPrefix.split('@');
            prefix = emailParts[0];
            domain = emailParts[1];
            console.log('æ£€æµ‹åˆ°å®Œæ•´é‚®ç®±ï¼Œæå–å‰ç¼€:', prefix, 'åŸŸå:', domain);
          } else {
            // åªæœ‰å‰ç¼€ï¼Œæ²¡æœ‰åŸŸå
            prefix = emailOrPrefix;
            domain = domainSelect ? domainSelect.value : null; // ä½¿ç”¨å½“å‰é€‰æ‹©çš„åŸŸå
          }
          
          // å¦‚æœæ²¡æœ‰å¯†ç ä½†å¯ç”¨äº†"ä½¿ç”¨å‰ç¼€ä½œä¸ºå¯†ç "é€‰é¡¹
          if (!password && usePrefixAsPassword && prefix) {
            password = prefix;
          }
          
          if (!prefix || (parts.length !== 2 && !usePrefixAsPassword)) {
            invalidLines.push(`ç¬¬ ${index + 1} è¡Œ: ${line}`);
          } else {
            records.push({
              prefix: prefix,
              password: password || prefix, // å¦‚æœæ²¡æœ‰å¯†ç ï¼Œä½¿ç”¨å‰ç¼€ä½œä¸ºå¯†ç 
              domain: domain // å¯èƒ½ä¸ºnull
            });
          }
        });
        
        // å¦‚æœæœ‰æ— æ•ˆè¡Œï¼Œæ˜¾ç¤ºé”™è¯¯
        if (invalidLines.length > 0) {
          const message = `ä»¥ä¸‹ ${invalidLines.length} è¡Œæ ¼å¼æ— æ•ˆï¼Œè¯·ä¿®æ”¹åé‡è¯•:\n${invalidLines.join('\n')}`;
          showError(batchError, message);
          return;
        }
        
        // å¼€å§‹æ‰¹é‡å¯¼å…¥
        importStatus.textContent = `æ­£åœ¨å¯¼å…¥ ${records.length} æ¡è®°å½•...`;
        
        try {
          console.log('å‘é€æ‰¹é‡å¯¼å…¥è¯·æ±‚ï¼Œæ•°æ®:', records);
          // ä½¿ç”¨æ–°çš„æ‰¹é‡API
          const response = await fetch('/api/admin/batch-prefixes', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              adminKey,
              records
            })
          });
          
          // å³ä½¿ä¸æ˜¯200çŠ¶æ€ç ä¹Ÿå…ˆè·å–å“åº”å†…å®¹
          const responseText = await response.text();
          console.log('æœåŠ¡å™¨å“åº”:', responseText);
          
          // å°è¯•è§£æJSON
          let data;
          try {
            data = JSON.parse(responseText);
          } catch (e) {
            console.error('å“åº”ä¸æ˜¯æœ‰æ•ˆçš„JSON:', responseText);
            showError(batchError, 'æœåŠ¡å™¨è¿”å›äº†æ— æ•ˆçš„å“åº”æ ¼å¼');
            return;
          }
          
          if (response.ok) {
            if (data.failedCount > 0) {
              const failMessage = `æˆåŠŸå¯¼å…¥ ${data.successCount} æ¡è®°å½•ï¼Œå¤±è´¥ ${data.failedCount} æ¡:\n` +
                data.failedRecords.map(r => `- ${r.prefix}: ${r.reason}`).join('\n');
              showError(batchError, failMessage);
            } else {
              showSuccess(batchSuccess, `æˆåŠŸå¯¼å…¥æ‰€æœ‰ ${data.successCount} æ¡è®°å½•!`);
              batchImportTextarea.value = ''; // æ¸…ç©ºè¾“å…¥æ¡†
            }
            
            importStatus.innerHTML = `å¯¼å…¥å®Œæˆ: ${data.successCount}/${records.length} æˆåŠŸ`;
            importStatus.style.color = '#27ae60';
            
            // é‡æ–°åŠ è½½å‰ç¼€åˆ—è¡¨
            loadPrefixes();
          } else {
            showError(batchError, data.error || `æ‰¹é‡å¯¼å…¥æ—¶å‡ºé”™ï¼ŒçŠ¶æ€ç : ${response.status}`);
          }
        } catch (error) {
          console.error('æ‰¹é‡å¯¼å…¥æ—¶å‡ºé”™:', error);
          showError(batchError, 'è¿æ¥æœåŠ¡å™¨æ—¶å‡ºé”™: ' + error.message);
        }
      });

      // æ‰¹é‡åˆ é™¤é€‰ä¸­çš„é‚®ç®±
      async function deleteSelectedPrefixes() {
        const selectedCheckboxes = document.querySelectorAll('.row-checkbox:checked');
        const selectedCount = selectedCheckboxes.length;
        
        if (selectedCount === 0) {
          showError(addError, 'è¯·å…ˆé€‰æ‹©è¦åˆ é™¤çš„é‚®ç®±');
          return;
        }
        
        if (!confirm(`ç¡®å®šè¦åˆ é™¤é€‰ä¸­çš„ ${selectedCount} ä¸ªé‚®ç®±å—ï¼Ÿ`)) {
          return;
        }
        
        const prefixes = Array.from(selectedCheckboxes).map(checkbox => 
          checkbox.getAttribute('data-prefix')
        );
        
        let successCount = 0;
        let failedCount = 0;
        
        // æ˜¾ç¤ºå¤„ç†çŠ¶æ€
        importStatus.textContent = `æ­£åœ¨æ‰¹é‡åˆ é™¤ (0/${prefixes.length})...`;
        importStatus.style.color = '#3498db';
        
        // å¾ªç¯å¤„ç†æ¯ä¸ªå‰ç¼€
        for (let i = 0; i < prefixes.length; i++) {
          const prefix = prefixes[i];
          importStatus.textContent = `æ­£åœ¨æ‰¹é‡åˆ é™¤ (${i+1}/${prefixes.length})...`;
          
          try {
            const response = await fetch(`/api/admin/prefixes/${prefix}`, {
              method: 'DELETE',
              headers: {
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({ adminKey })
            });
            
            if (response.ok) {
              successCount++;
            } else {
              failedCount++;
            }
          } catch (error) {
            failedCount++;
            console.error(`åˆ é™¤å‰ç¼€ ${prefix} æ—¶å‡ºé”™:`, error);
          }
        }
        
        // æ˜¾ç¤ºå¤„ç†ç»“æœ
        if (failedCount > 0) {
          showError(addError, `æ‰¹é‡åˆ é™¤å®Œæˆ: æˆåŠŸ ${successCount}ï¼Œå¤±è´¥ ${failedCount}`);
        } else {
          showSuccess(addSuccess, `æˆåŠŸåˆ é™¤æ‰€æœ‰ ${successCount} ä¸ªé€‰ä¸­çš„é‚®ç®±`);
        }
        
        // é‡æ–°åŠ è½½å‰ç¼€åˆ—è¡¨
        loadPrefixes();
      }
      
      // æ›´æ–°é€‰æ‹©çŠ¶æ€
      function updateSelectionStatus() {
        const checkboxes = document.querySelectorAll('.row-checkbox');
        const checkedBoxes = document.querySelectorAll('.row-checkbox:checked');
        const checkedCount = checkedBoxes.length;
        
        // æ›´æ–°å…¨é€‰æ¡†çŠ¶æ€
        if (checkboxes.length > 0 && checkedCount === checkboxes.length) {
          selectAllCheckbox.checked = true;
          selectAllHeader.checked = true;
        } else {
          selectAllCheckbox.checked = false;
          selectAllHeader.checked = false;
        }
        
        // æ›´æ–°é€‰ä¸­æ•°é‡æ˜¾ç¤º
        if (checkedCount > 0) {
          selectedCount.textContent = `å·²é€‰æ‹© ${checkedCount} é¡¹`;
          batchDeleteBtn.style.display = 'inline-block';
        } else {
          selectedCount.textContent = '';
          batchDeleteBtn.style.display = 'none';
        }
      }
      
      // æ·»åŠ ç¿»é¡µå’Œå…¨é€‰ç›¸å…³äº‹ä»¶
      function initPaginationAndBatchActions() {
        // åº•éƒ¨ç¿»é¡µäº‹ä»¶
        prevPageBtn.addEventListener('click', () => {
          console.log('ç‚¹å‡»å‰ä¸€é¡µ', currentPage);
          if (currentPage > 1) {
            currentPage--;
            updatePaginationInfo();
            displayCurrentPagePrefixes();
          }
        });
        
        nextPageBtn.addEventListener('click', () => {
          console.log('ç‚¹å‡»åä¸€é¡µ', currentPage);
          const totalPages = Math.ceil(totalItems / pageSize) || 1;
          if (currentPage < totalPages) {
            currentPage++;
            updatePaginationInfo();
            displayCurrentPagePrefixes();
          }
        });
        
        // é¡¶éƒ¨ç¿»é¡µäº‹ä»¶
        const topPrevPageBtn = document.getElementById('top-prev-page');
        const topNextPageBtn = document.getElementById('top-next-page');
        const topCurrentPageSpan = document.getElementById('top-current-page');
        const topTotalPagesSpan = document.getElementById('top-total-pages');
        const topPageSizeSelect = document.getElementById('top-page-size');
        
        topPrevPageBtn.addEventListener('click', () => {
          console.log('ç‚¹å‡»é¡¶éƒ¨å‰ä¸€é¡µ', currentPage);
          if (currentPage > 1) {
            currentPage--;
            updatePaginationInfo();
            displayCurrentPagePrefixes();
          }
        });
        
        topNextPageBtn.addEventListener('click', () => {
          console.log('ç‚¹å‡»é¡¶éƒ¨åä¸€é¡µ', currentPage);
          const totalPages = Math.ceil(totalItems / pageSize) || 1;
          if (currentPage < totalPages) {
            currentPage++;
            updatePaginationInfo();
            displayCurrentPagePrefixes();
          }
        });
        
        // åŒæ­¥é¡¶éƒ¨å’Œåº•éƒ¨çš„é¡µé¢å¤§å°é€‰æ‹©
        topPageSizeSelect.value = pageSizeSelect.value;
        
        // é¡µé¢å¤§å°å˜æ›´äº‹ä»¶ - åº•éƒ¨
        pageSizeSelect.addEventListener('change', () => {
          pageSize = parseInt(pageSizeSelect.value);
          topPageSizeSelect.value = pageSizeSelect.value; // åŒæ­¥é¡¶éƒ¨é€‰æ‹©
          currentPage = 1; // é‡ç½®åˆ°ç¬¬ä¸€é¡µ
          updatePaginationInfo();
          displayCurrentPagePrefixes();
        });
        
        // é¡µé¢å¤§å°å˜æ›´äº‹ä»¶ - é¡¶éƒ¨
        topPageSizeSelect.addEventListener('change', () => {
          pageSize = parseInt(topPageSizeSelect.value);
          pageSizeSelect.value = topPageSizeSelect.value; // åŒæ­¥åº•éƒ¨é€‰æ‹©
          currentPage = 1; // é‡ç½®åˆ°ç¬¬ä¸€é¡µ
          updatePaginationInfo();
          displayCurrentPagePrefixes();
        });
        
        // å…¨é€‰äº‹ä»¶
        selectAllCheckbox.addEventListener('change', () => {
          const isChecked = selectAllCheckbox.checked;
          document.querySelectorAll('.row-checkbox').forEach(checkbox => {
            checkbox.checked = isChecked;
          });
          selectAllHeader.checked = isChecked;
          updateSelectionStatus();
        });
        
        selectAllHeader.addEventListener('change', () => {
          const isChecked = selectAllHeader.checked;
          document.querySelectorAll('.row-checkbox').forEach(checkbox => {
            checkbox.checked = isChecked;
          });
          selectAllCheckbox.checked = isChecked;
          updateSelectionStatus();
        });
        
        // æ‰¹é‡åˆ é™¤äº‹ä»¶
        batchDeleteBtn.addEventListener('click', deleteSelectedPrefixes);
      }

      // åœ¨é¡µé¢åŠ è½½å®Œæˆåè°ƒç”¨åˆå§‹åŒ–å‡½æ•°
      initializePage();
    });
  </script>
</body>
</html>